apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: run-tip-
spec:

  # Start with the front end for gathering user input.
  entrypoint: tipapp

  # Default params
  arguments:
    parameters:
    - name: ext_ch10_mnt_point
      value: /bad/ch10/mount/point
    - name: ext_icd_mnt_point
      value: /bad/icd/mount/point
    - name: ch10_file_name
      value: default ch10 file name
    - name: icd_file_name
      value: default icd file name
    - name: overwrite
      value: false
    - name: video
      value: false

  templates:
  
  - name: tipapp
    dag:
      tasks:
      - name: front-end
        template: faux-front-end
        arguments:
          parameters: [
	      {name: ext_ch10_mnt_point, value: "{{workflow.parameters.ext_ch10_mnt_point}}"},
	      {name: ch10_file_name, value: "{{workflow.parameters.ch10_file_name}}"},
	      {name: ext_icd_mnt_point, value: "{{workflow.parameters.ext_icd_mnt_point}}"},
	      {name: icd_file_name, value: "{{workflow.parameters.icd_file_name}}"},
	      {name: overwrite, value: "{{workflow.parameters.overwrite}}"},
	      {name: video, value: "{{workflow.parameters.video}}"}
	    ]
      - name: tip-exe
        dependencies: [front-end]
        template: tip
        arguments:
          parameters: [
	      {name: conf, value: "{{tasks.front-end.outputs.parameters.tip-configuration}}"},
	      {name: ext_ch10_mnt_point, value: "{{tasks.front-end.outputs.parameters.out_ch10_mnt_point}}"},
	      {name: ext_icd_mnt_point, value: "{{tasks.front-end.outputs.parameters.out_icd_mnt_point}}"}
	      ]

  - name: faux-front-end
    retryStrategy:
      limit: 0
    inputs:
      parameters: 
      - name: ext_ch10_mnt_point
      - name: ext_icd_mnt_point
      - name: ch10_file_name
      - name: icd_file_name
      - name: overwrite
      - name: video
    outputs:
      parameters:
      - name: tip-configuration
        valueFrom:
          path: /app/data.yml
      - name: out_ch10_mnt_point
        valueFrom:
          path: /app/ext_ch10_mnt_point
      - name: out_icd_mnt_point
        valueFrom:
          path: /app/ext_icd_mnt_point
    container: 
      image: frontend:2
      imagePullPolicy: Never
      stdin: true
      tty: true
      livenessProbe:
        initialDelaySeconds: 1
        periodSeconds: 2
        timeoutSeconds: 10
        exec:
          command: [cat, /app/healthy]
      readinessProbe:
        initialDelaySeconds: 15
        periodSeconds: 2
        timeoutSeconds: 300
        exec:
          command: [cat, /app/ready]
      terminationMessagePath: /app/termination-log
      args: [
        "{{inputs.parameters.ext_ch10_mnt_point}}",
	"{{inputs.parameters.ch10_file_name}}",
	"{{inputs.parameters.ext_icd_mnt_point}}",
	"{{inputs.parameters.icd_file_name}}",
	"{{inputs.parameters.overwrite}}",
	"{{inputs.parameters.video}}"
	]
      #status:

  - name: tip
    retryStrategy:
      limit: 0
    inputs:
      parameters: 
      - name: conf
      - name: ext_ch10_mnt_point
      - name: ext_icd_mnt_point
    container: 
      image: runtip:1
      imagePullPolicy: Never
      stdin: true
      tty: true
      #livenessProbe:
      #  initialDelaySeconds: 1
      #  periodSeconds: 2
      #  timeoutSeconds: 10
      #  exec:
      #    command: [cat, /app/healthy]
      #readinessProbe:
      #  initialDelaySeconds: 15
      #  periodSeconds: 2
      #  timeoutSeconds: 300
      #  exec:
      #    command: [cat, /app/ready]
      #terminationMessagePath: /app/termination-log
      args: ["{{inputs.parameters.conf}}"]
      volumeMounts:
      - name: ch10mnt
        mountPath: /ch10mnt
      - name: icdmnt
        mountPath: /icdmnt
    volumes:
    - name: ch10mnt
      hostPath:
        path: "{{inputs.parameters.ext_ch10_mnt_point}}"
        type: Directory
    - name: icdmnt
      hostPath:
        path: "{{inputs.parameters.ext_icd_mnt_point}}"
        type: Directory

